import logging
from telegram import Update
from telegram.ext import Application, CommandHandler, ContextTypes

logger = logging.getLogger(__name__)

class TransactionBot:
    def __init__(self, token, database):
        self.token = token
        self.db = database
        self.app = Application.builder().token(token).build()
        self.setup_handlers()
    
    def setup_handlers(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø±"""
        self.app.add_handler(CommandHandler('start', self.start_command))
        self.app.add_handler(CommandHandler('help', self.help_command))
        self.app.add_handler(CommandHandler('stats', self.stats_command))
    
    async def start_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©"""
        user = update.effective_user
        
        # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if not self.db.get_user(user.id):
            self.db.add_user(
                user_id=user.id,
                full_name=user.full_name or user.username,
                telegram_username=user.username
            )
        
        welcome_text = f"""
ğŸ‰ Ù…Ø±Ø­Ø¨Ø§Ù‹ {user.full_name}!

ğŸ“‹ **Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª**

Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù…ØªØ§Ø­Ø©:
/start - Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
/help - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
/stats - Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª

âœ… Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!
        """
        
        await update.message.reply_text(welcome_text)
    
    async def help_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø£Ù…Ø± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©"""
        help_text = """
ğŸ“š **Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:**

**Ø§Ù„Ø£ÙˆØ§Ù…Ø±:**
/start - Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
/help - Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
/stats - Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª

ğŸ”” **Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©:**
Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‚Ø¨Ù„ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª.
        """
        await update.message.reply_text(help_text)
    
    async def stats_command(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
        """Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª"""
        try:
            user_id = update.effective_user.id
            stats = self.db.get_user_statistics(user_id)
            
            stats_text = f"""
ğŸ“ˆ **Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙƒ:**

ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª: {stats.get('total_transactions', 0)}
âœ… Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©: {stats.get('active_transactions', 0)}
ğŸ‰ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø©: {stats.get('completed_transactions', 0)}

âš ï¸ ØªÙ†ØªÙ‡ÙŠ Ù‚Ø±ÙŠØ¨Ø§Ù‹: {stats.get('due_soon', 0)}
            """
            
            await update.message.reply_text(stats_text)
        except Exception as e:
            logger.error(f"Error getting stats: {e}")
            await update.message.reply_text("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª")
    
    def run(self):
        """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
        logger.info("ğŸ¤– Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
        self.app.run_polling(allowed_updates=Update.ALL_TYPES)
